<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>A Case Study on Jenkins RCE :: Adam Jordan&#39;s Blog — Things I am interested in</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="During my past experience assessing the security of Jenkins, I found several things I personally deemed interesting, such as how to craft RCE payload by analyzing patches and how critical the information a Jenkins instance possesses. In this post, I will walk through each step starting from initial information gathering to potential post-exploitation techniques in a Jenkins instance. I will discuss the thinking process and the possible damage impacted in case of compromise."/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://blog.adamjordan.id/posts/003-case-study-on-jenkins-rce/" />





<link rel="stylesheet" href="https://blog.adamjordan.id/assets/style.css">


<link rel="stylesheet" href="https://blog.adamjordan.id/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://blog.adamjordan.id/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="https://blog.adamjordan.id/img/favicon.png">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="A Case Study on Jenkins RCE"/>
<meta name="twitter:description" content="During my past experience assessing the security of Jenkins, I found several things I personally deemed interesting, such as how to craft RCE payload by analyzing patches and how critical the information a Jenkins instance possesses. In this post, I will walk through each step starting from initial information gathering to potential post-exploitation techniques in a Jenkins instance. I will discuss the thinking process and the possible damage impacted in case of compromise. "/>



<meta property="og:title" content="A Case Study on Jenkins RCE" />
<meta property="og:description" content="During my past experience assessing the security of Jenkins, I found several things I personally deemed interesting, such as how to craft RCE payload by analyzing patches and how critical the information a Jenkins instance possesses. In this post, I will walk through each step starting from initial information gathering to potential post-exploitation techniques in a Jenkins instance. I will discuss the thinking process and the possible damage impacted in case of compromise. " />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.adamjordan.id/posts/003-case-study-on-jenkins-rce/" />
<meta property="article:published_time" content="2020-01-21T17:40:00+08:00" />
<meta property="article:modified_time" content="2020-01-21T17:40:00+08:00" /><meta property="og:site_name" content="Adam Jordan&#39;s Blog" />






  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">Adam Jordan&#39;s Blog</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/security">Security</a></li>
        
      
        
          <li><a href="/archive">Archive</a></li>
        
      
        
          <li><a href="/about">About</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/security">Security</a></li>
      
    
      
        <li><a href="/archive">Archive</a></li>
      
    
      
        <li><a href="/about">About</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  <div class="post">
    <h2 class="post-title"><a href="https://blog.adamjordan.id/posts/003-case-study-on-jenkins-rce/">A Case Study on Jenkins RCE</a></h2>
    <div class="post-meta">
      
        <span class="post-date">
            21-01-2020
        </span>
      
      <span class="post-author">— Written by Adam Jordan</span>
      
        <span class="post-read-time">— 7 min read</span>
      
    </div>

    
      <span class="post-tags">
        
          #<a href="https://blog.adamjordan.id/tags/security/">security</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      

<p>During my past experience assessing the security of Jenkins, I found several things I personally deemed interesting,
such as how to craft RCE payload by analyzing patches and how critical the information a Jenkins instance possesses.
In this post, I will walk through each step starting from initial information gathering to potential post-exploitation techniques in a Jenkins instance.
I will discuss the thinking process and the possible damage impacted in case of compromise.</p>

<h2 id="information-gathering">Information Gathering</h2>

<p>The first thing to do is to collect information about past vulnerabilities and exploits.
The best place to find this information is the <a href="https://jenkins.io/security/advisories/">Jenkin&rsquo;s official security advisories</a>.
At that time (January 2019), we saw that there is a <em>Sandbox Bypass</em> vulnerability patched in the latest version in the
<a href="https://jenkins.io/security/advisory/2019-01-08/">2019-01-08 Advisory</a>.</p>

<blockquote>
<p><strong>Sandbox Bypass in Script Security and Pipeline Plugins</strong></p>

<p><strong>SECURITY-1266 / CVE-2019-1003000 (Script Security), CVE-2019-1003001 (Pipeline: Groovy), CVE-2019-1003002 (Pipeline: Declarative)</strong></p>

<p>Script Security sandbox protection could be circumvented during the script compilation phase by applying AST transforming annotations such as @Grab to source code elements.</p>

<p>Both the pipeline validation REST APIs and actual script/pipeline execution are affected.</p>

<p>This allowed users with Overall/Read permission, or able to control Jenkinsfile or sandboxed Pipeline shared library contents in SCM, to bypass the sandbox protection and execute arbitrary code on the Jenkins master.</p>

<p>All known unsafe AST transformations in Groovy are now prohibited in sandboxed scripts.</p>
</blockquote>

<p>At that time, the proof of concept is not yet published by the reporter (<a href="https://twitter.com/orange_8361/status/1085510564393041925">Orange Tsai</a>).
Since we are interested in how to exploit this vulnerability, the thing we can do is to look into the patches.
This is quite easy because Jenkins is an open-source project.
We can see every detailed commit on their repository.
We can find the related commit in <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1667566">Bugzilla page</a>.</p>

<p>The upstream patches:</p>

<ul>
<li><a href="https://github.com/jenkinsci/pipeline-model-definition-plugin/commit/083abd96e68fd89f556a0cd53db5f878dbf09b92">https://github.com/jenkinsci/pipeline-model-definition-plugin/commit/083abd96e68fd89f556a0cd53db5f878dbf09b92</a></li>
<li><a href="https://github.com/jenkinsci/script-security-plugin/commit/2c5122e50742dd16492f9424992deb21cc07837c">https://github.com/jenkinsci/script-security-plugin/commit/2c5122e50742dd16492f9424992deb21cc07837c</a></li>
<li><a href="https://github.com/jenkinsci/workflow-cps-plugin/commit/d09583eda7898eafdd15297697abdd939c6ba5b6">https://github.com/jenkinsci/workflow-cps-plugin/commit/d09583eda7898eafdd15297697abdd939c6ba5b6</a></li>
</ul>

<h2 id="reading-the-patches">Reading the Patches</h2>

<p>In the repository, we can see that the patches are blacklisting some annotations. Let&rsquo;s examine this <a href="https://github.com/jenkinsci/workflow-cps-plugin/commit/d09583eda7898eafdd15297697abdd939c6ba5b6">commit</a>.</p>

<p>We can see that there is a difference in how <code>GroovySandbox</code> class creates the <em>compiler configuration</em>.
There is an additional step that add <em>compilation customizer</em> <code>RejectASTTransformsCustomizer</code> that with a the disabled transformations of only a single value: <code>GrabAnnotationTransformation.class.getName()</code>.</p>

<p><img src="/post_assets/001/commit-compiler-configuration.png" alt="Compiler Configuration Diff" /></p>

<p>The <code>RejectASTTransformsCustomizer</code> is a new class with a logic that traverse annotations and do simple blacklist checking:</p>

<p><img src="/post_assets/001/commit-reject-transformation.png" alt="Reject Transformation Commit" /></p>

<p>We can also see that there is a new test code that check if the blacklist <code>Grab</code> annotation.</p>

<p><img src="/post_assets/001/commit-test-code.png" alt="Test Code Commit" /></p>

<h2 id="the-grab-annotation">The Grab Annotation</h2>

<p>The <code>Grab</code> is an annotation implemented within the <a href="http://docs.groovy-lang.org/latest/html/documentation/grape.html">Grape</a>, a JAR dependency manager embedded into Groovy.
By using Grape, we can add any external maven repository dependencies to the classpath.</p>

<p>Example usage of Grab annotation is:</p>

<pre><code class="language-java"> @Grab('commons-lang:commons-lang:2.4')
 import org.apache.commons.lang.WordUtils
 println &quot;Hello ${WordUtils.capitalize('world')}&quot;
</code></pre>

<p>During compile-time, this will add <code>commons-lang:commons-lang:2.4</code> library as dependency in classpath.
Then, we can import <code>org.apache.commons.lang.WordUtils</code> defined from <code>commons-lang</code>.</p>

<h2 id="exploit-idea">Exploit Idea</h2>

<p>For information, Jenkins&rsquo;s pipeline build script is written in groovy.
Upon executing a pipeline job, this build script will be compiled (and executed) in Jenkins master, resulting in a definition of the pipeline, e.g. what to do in slave nodes.
As a security measure, Jenkins provides a mechanism for the script to be executed in <em>sandbox mode</em>. In sandbox mode, all dangerous functions are blacklisted, so regular user cannot do anything malicious to the Jenkins node servers.</p>

<p>As mentioned before, the build script is written in Groovy.
Groovy script allows us  to use any class or function in Java packages. However, in sandbox mode, dangerous built-in ones are blacklisted.
But we can see that&rsquo;s not the case for <strong>non-built-in</strong> class.</p>

<p>Furthermore, we can use meta-programming available in Groovy to execute code during compile-time, which leads us to the <code>Grab</code> annotation.
With <code>Grab</code>, we can make Jenkins import arbitrary packages from external maven repository during build-script compile-time.</p>

<p>So the idea is: we need the Jenkins master process runner to import a java class with command execution functionality during job script compile-time.
Then, we use that java class to execute shell command in Jenkins master.</p>

<h2 id="using-grab-to-import-malicious-class">Using @Grab to import malicious class</h2>

<p>Some googling leads us to a java library called <code>jproc</code>.
After quick examination, we can use <a href="https://github.com/fleipold/jproc/blob/master/src/main/java/org/buildobjects/process/ProcBuilder.java"><code>ProcBuilder</code></a> class defined in <a href="https://mvnrepository.com/artifact/org.buildobjects/jproc/2.2.3"><code>org.buildobjects:jproc:2.2.3</code></a> to run system shell command.</p>

<p>So, putting everything together, the payload is defined as below:</p>

<pre><code class="language-java">import org.buildobjects.process.ProcBuilder
@Grab('org.buildobjects:jproc:2.2.3')
class Dummy{ }
print new ProcBuilder(&quot;/bin/bash&quot;).withArgs(&quot;-c&quot;,&quot;cat /etc/passwd&quot;).run().getOutputString()
</code></pre>

<h2 id="rce-demo">RCE Demo</h2>

<p>Let&rsquo;s try putting the pipeline script in a Jenkins Job with <em>Use Groovy Sandbox</em> enabled.</p>

<p><img src="/post_assets/001/jenkins-job-script.png" alt="Job Script in Jenkins" /></p>

<p>After triggering the job build, the script above will be compiled and executed in Jenkins master. After the job build is done, we can see the result of the shell command <code>cat /etc/passwd</code> in the job console output.</p>

<p><img src="/post_assets/001/jenkins-passwd.png" alt="Passwd exposed in Jenkins" /></p>

<p>Furthermore, we can work on getting the reverse shell session using the same method.</p>

<h2 id="post-exploitation">Post Exploitation</h2>

<p>After getting shell access to the Jenkins master server.
The next thing we can do is to further increase the damage, including but not limited to:</p>

<ul>
<li>Obtain Jenkins web admin account</li>
<li>Maintaining persistence</li>
<li>Steal source code</li>
<li>Steal keys and secrets</li>
</ul>

<p>From a page <a href="https://wiki.jenkins.io/display/JENKINS/Securing+JENKINS_HOME">Securing JENKINS_HOME</a>, we know that Jenkins is putting all their info and states in <code>$JENKINS_HOME</code>, by default it is located in directory <code>/var/jenkins</code>.</p>

<h4 id="accessing-encrypted-sensitive-information">Accessing encrypted sensitive information</h4>

<p>Jenkins are not using any DBMS to store data, it stores data and states in XML file under <code>$JENKINS_HOME</code>.
In this directory, we can read (and modify) information about the users, jobs, etc.
However, sensitive data (e.g.s secrets) is encrypted.</p>

<p>Fortunately (<em>or unfortunately?</em>), Jenkins also stores the encryption key under the same <code>$JENKINS_HOME</code> directory.
I am not saying that this is a bad practice, because the problem of storing key itself is a hard problem. You may search more about this in google with term <em>&ldquo;Secret Zero Problem&rdquo;</em>.</p>

<p>Basically, there are two files needed for decrypting the encryption: <code>secrets/master.key</code> and <code>secrets/hudson.util.Secret</code>.
With these two file, we can decrypt all the encrypted information inside Jenkins.
For example we can decrypt Jenkins secret stored in <code>credentials.xml</code>. There are already many scripts on the internet for decrypting the Jenkins secret, e.g. <a href="https://github.com/tweksteen/jenkins-decrypt/blob/master/decrypt.py">jenkins-decrypt</a>.</p>

<h4 id="web-admin-account-hijack">Web admin account hijack</h4>

<p>We can see a list of user at <code>$JENKINS_HOME/users</code>.
Moreover, we can see data or state about the user at <code>$JENKINS/users/[user]/config.xml</code>.
In an older Jenkins version, if a user has generated access tokens before, those access tokens are stored and retrievable in <code>config.xml</code>.</p>

<p>We can use this access token to authenticate in Jenkins Web dashboard by setting it in <code>Authorization</code> HTTP Header.
For demonstration, we can use curl to do <em>whoami</em> in Jenkins:</p>

<p><img src="/post_assets/001/post-whoami.png" alt="Account Hijack" /></p>

<h4 id="maintaining-persistence">Maintaining Persistence</h4>

<p>Apart from regular maintaining persistence techniques, such as using crontab, or injecting <code>.bashrc</code>, we can utilize the hijacked Jenkins admin account.
Jenkins provides a script console functionality that can be used admin to execute arbitrary Groovy script in <strong>non-sandbox</strong> mode.</p>

<p><img src="/post_assets/001/post-console.png" alt="Script Console" /></p>

<p>Moreover, we can also use this console to enumerate stored secrets in Jenkins with the following script:</p>

<pre><code class="language-java">import com.cloudbees.plugins.credentials.*

// list credentials
credentials = SystemCredentialsProvider.getInstance().getCredentials()
println credentials

println ''
println credentials[0]['username'] + ':' + credentials[0]['password']
</code></pre>

<p><img src="/post_assets/001/post-credential.png" alt="Enumerate Credential in Console" /></p>

<p>Furthermore, most of the time Jenkins will also store a Git user <strong>SSH Key</strong>.
This is because of its nature as a CI/CD service, Jenkins usually store the SSH Key to <strong>pull source code</strong> and <strong>deploy to production servers</strong>.
If we can get access to this SSH Key, we can use it to steal source code, and also perform lateral movement to production servers, resulting in very big damage.</p>

<h2 id="verdict-on-the-method">Verdict on the Method</h2>

<p>Different from a <a href="https://blog.orange.tw/2019/02/abusing-meta-programming-for-unauthenticated-rce.html">writeup by Orange</a> that does not require any valid user in Jenkins,
this method requires a valid Jenkins user with <code>Job/Configure</code> permission and optionally <code>Job/Build</code> to trigger build execution.
Nonetheless, this method displays how we can exploit CVE-2019-1003000 to escape the sandbox bypass, and then execute arbitrary command with a normal Jenkins user.
Furthermore, this vulnerability can also be chained with previous vulnerabilities that allow unauthenticated RCE.
I recommend reading this <a href="https://blog.orange.tw/2019/02/abusing-meta-programming-for-unauthenticated-rce.html">article</a>.</p>

<h2 id="postface">Postface</h2>

<p>In real world case, we can imagine this vulnerability being exploited by both internal and external threat in a tech company.
Being a central CI/CD service, compromising Jenkins will lead attackers to gain access to source code, deployment credentials and secrets, and even supply chain attack.</p>

<p>We can learn from the past incidents that the damage is fatal:</p>

<ul>
<li><p><a href="https://threatpost.com/ge-aviation-passwords-jenkins-server/146302/">GE Aviation passwords, source code exposed in open jenkins server</a></p></li>

<li><p><a href="https://matrix.org/blog/2019/04/11/we-have-discovered-and-addressed-a-security-breach-updated-2019-04-12/">Matrix.org API keys stolen from unpatched Jenkins server, leading to defacement</a></p></li>
</ul>

<p>We need to also be aware that Jenkins is an old piece of software written in early 2000s and may contains many legacy code and bugs.</p>

<p><img src="/post_assets/001/verdict-vulns.png" alt="Jenkins Vulnerabilities" /></p>

<p>From the charts (<a href="https://www.cvedetails.com/product/34004/Jenkins-Jenkins.html?vendor_id=15865">source</a>) displayed above,
we can see that Jenkins are affected by lots of critical vulnerabilities, especially in recent years.
Constant check and software update on Jenkins instance is highly recommended and necessary to create a safe environment within an organization.</p>

<h4 id="proof-of-concept-source-code">Proof-of-Concept Source Code</h4>

<p>I put a proof of concept based on this exploit method in Github:</p>

<blockquote>
<p><a href="https://github.com/adamyordan/cve-2019-1003000-jenkins-rce-poc">https://github.com/adamyordan/cve-2019-1003000-jenkins-rce-poc</a></p>
</blockquote>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h">Read other posts</span>
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://blog.adamjordan.id/posts/004-sectips-jan2020/">
                  <span class="button__icon">←</span>
                  <span class="button__text">SecTips #Jan20</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://blog.adamjordan.id/posts/002-hunterai-connecting-agent-with-unity/">
                  <span class="button__text">HunterAI #2: Connecting AI Agent with Unity</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    
    

    
      
        
    <br><br>
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "adam-blog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


      
    
    
    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">Adam Jordan&#39;s Blog</span>
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span>© 2020 Powered by <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span>
        <span>Theme created by <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span>
      </div>
    
  </div>
</footer>

<script src="https://blog.adamjordan.id/assets/main.js"></script>
<script src="https://blog.adamjordan.id/assets/prism.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        displayMath: [['$$','$$'], ['\[','\]']],
        processEscapes: true,
        processEnvironments: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
        TeX: { equationNumbers: { autoNumber: "AMS" },
            extensions: ["AMSmath.js", "AMSsymbols.js"] }
    }
});
</script>


      
    </div>

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-124774114-2', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
  </body>
</html>
